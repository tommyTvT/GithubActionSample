name: æ‹‰å–é•œåƒdocker

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæ–¹ä¾¿åç»­ç»´æŠ¤å’Œä¿®æ”¹
env:
  IMAGE_NAME: dannicool/docker-wechatbot-webhook
  TAR_FILENAME: wechatbot.tar

# å®šä¹‰è§¦å‘æ¡ä»¶ï¼šå…è®¸æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ
on:
  workflow_dispatch: # è¿™ä½¿ä½ å¯ä»¥ç›´æ¥åœ¨ GitHub çš„ Actions æ ‡ç­¾é¡µæ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµ

jobs:
  export-image:
    name: Pull and Export Docker Image
    runs-on: ubuntu-22.04-arm # ä½¿ç”¨ GitHub æ‰˜ç®¡çš„æœ€æ–° Ubuntu è¿è¡Œå™¨

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç ï¼ˆè™½ç„¶æœ¬ä¾‹å¯èƒ½ä¸éœ€è¦ä»£ç ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ï¼Œå¹¶ä¸”å¯ä»¥ä¸ºåç»­ä¿å­˜æ–‡ä»¶æä¾›è·¯å¾„ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šè®¾ç½® Docker ç¯å¢ƒï¼ˆä½¿ç”¨ Buildx ä»¥è·å¾—æ›´å¥½çš„æ„å»ºç‰¹æ€§ï¼Œè™½ç„¶æœ¬ä¾‹ä¸»è¦æ˜¯æ‹‰å–å’Œä¿å­˜ï¼‰
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # æ­¥éª¤3ï¼šä» Docker Hub æ‹‰å–æŒ‡å®šçš„é•œåƒ
      - name: Pull Docker image
        run: |
          docker pull $IMAGE_NAME

      # æ­¥éª¤4ï¼šä½¿ç”¨ docker save å‘½ä»¤å°†é•œåƒå¯¼å‡ºä¸º .tar æ–‡ä»¶
      - name: Save Docker image to tar file
        run: |
          docker save -o $TAR_FILENAME $IMAGE_NAME
          echo "é•œåƒå·²æˆåŠŸå¯¼å‡ºä¸ºï¼š$(pwd)/$TAR_FILENAME"
          ls -lh $TAR_FILENAME # åˆ—å‡ºæ–‡ä»¶ä¿¡æ¯ï¼Œä¾¿äºåœ¨æ—¥å¿—ä¸­ç¡®è®¤

      # æ­¥éª¤5ï¼šå°†å¯¼å‡ºçš„ .tar æ–‡ä»¶ä¸Šä¼ ä¸ºå·¥ä½œæµåˆ¶å“ï¼ˆArtifactï¼‰ï¼Œä¾›åç»­ä¸‹è½½
      - name: Upload Docker image tar file as artifact
        uses: actions/upload-artifact@v4
        with:
          name: exported-docker-image # åˆ¶å“çš„åç§°
          path: wechatbot.tar # è¦ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„ï¼Œä¸ä¸Šé¢ env ä¸­å®šä¹‰çš„ TAR_FILENAME å¯¹åº”
          # ä¿ç•™æœŸï¼ˆå¤©ï¼‰ï¼Œé»˜è®¤ä¸º90å¤©ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´
          retention-days: 7

      # ï¼ˆå¯é€‰ï¼‰æ­¥éª¤6ï¼šè¾“å‡ºæˆåŠŸä¿¡æ¯
      - name: Success Notification
        run: |
          echo "âœ… Docker é•œåƒ '$IMAGE_NAME' å·²æˆåŠŸæ‹‰å–å¹¶å¯¼å‡ºä¸º '$TAR_FILENAME'ã€‚"
          echo "ğŸ“¦ è¯·åœ¨ä¸Šæ–¹çš„ 'Artifacts' åŒºåŸŸä¸‹è½½æ–‡ä»¶ 'exported-docker-image'ã€‚"
